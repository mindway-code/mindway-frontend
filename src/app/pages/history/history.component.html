<div class="history-container">
	<div class="history-header">
		<h2>Histórico de Atendimentos</h2>
		<p class="text-muted">Veja todos os atendimentos realizados, detalhes e tarefas associadas.</p>
	</div>
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-accent" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>
  <div *ngIf="!loading && attendances.length === 0" >
      Nenhum atendimento realizado ainda.
  </div>

	<div class="timeline">

		<div *ngFor="let att of attendances; let i = index" class="timeline-item">
			<div class="timeline-dot"></div>
			<div class="timeline-content card shadow-sm rounded-4 mb-4 p-2 ms-3 py-3">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
						<h5 class="mb-0">
							<i class="bi bi-calendar-check-fill me-2 text-accent"></i>
							{{ att.user.name }} {{ att.user.surname }}
						</h5>
						<small class="text-muted">
							<i class="bi bi-clock me-1"></i>
							{{ att.started_at | date:'dd/MM/yyyy HH:mm' }}
							<span *ngIf="att.started_at && att.ended_at">&nbsp;•&nbsp;{{ getDuration(att.started_at, att.ended_at) }}</span>
						</small>
					</div>
					<div class="mb-2">
						<span class="badge bg-primary text-light">{{ att.therapist.name }} {{ att.therapist.surname }}</span>
					</div>
					<p class="history-summary mb-2">{{ att.summary }}</p>
					<button class="btn btn-outline-accent btn-sm mb-2" (click)="toggleExpand(i)">
						<i class="bi" [ngClass]="expanded[i] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
						{{ expanded[i] ? 'Ocultar Detalhes' : 'Ver Detalhes' }}
					</button>
					<div *ngIf="expanded[i]">
						<div *ngIf="att.tasks && att.tasks.length > 0" class="tasks-list mb-2">
							<h6 class="mb-2"><i class="bi bi-list-check text-accent me-2"></i>Tarefas do Atendimento</h6>
							<ul class="list-group">
								<li class="list-group-item" *ngFor="let task of att.tasks">
									<span [class.text-success]="task.status === 'done'" [class.text-muted]="task.status !== 'done'">
										<i class="bi" [ngClass]="task.status === 'done' ? 'bi-check-circle-fill' : 'bi-circle'" class="me-2"></i>
										{{ task.description }}
									</span>
									<span class="badge bg-light text-muted ms-2" *ngIf="task.due_date">{{ task.due_date | date:'dd/MM/yyyy' }}</span>
								</li>
							</ul>
						</div>
						<div class="details-row flex-wrap mt-2">
							<div><b>Início:</b> {{ att.started_at | date:'dd/MM/yyyy HH:mm' }}</div>
							<div><b>Fim:</b> {{ att.ended_at | date:'dd/MM/yyyy HH:mm' }}</div>
							<div><b>Duração:</b> {{ getDuration(att.started_at, att.ended_at) }}</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
